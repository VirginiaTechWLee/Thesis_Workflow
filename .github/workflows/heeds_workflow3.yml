name: HEEDS Study Workflow3

on:
  workflow_dispatch:
    inputs:
      heeds_project:
        description: 'HEEDS project to run'
        required: true
        default: 'quick_test'
        type: choice
        options:
          - quick_test
          - full_sweep
          - Square_Beam_scenario_short_rev
      folder_mode:
        description: 'How to handle existing folders'
        required: true
        default: 'overwrite_existing'
        type: choice
        options:
          - overwrite_existing
          - skip_if_exists
          - create_new_timestamp
      timeout_minutes:
        description: 'Timeout in minutes'
        required: true
        default: '120'
        type: string

jobs:
  run-heeds-study:
    runs-on: self-hosted
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display Configuration
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          Log "========================================================"
          Log "  HEEDS STUDY WORKFLOW - CONFIGURATION"
          Log "========================================================"
          Log "Project: ${{ github.event.inputs.heeds_project }}"
          Log "Folder mode: ${{ github.event.inputs.folder_mode }}"
          Log "Timeout: ${{ github.event.inputs.timeout_minutes }} minutes"
          Log "Runner: ${{ runner.name }}"
          Log "Workspace: ${{ github.workspace }}"
          Log "HEEDS MDO: ${{ vars.HEEDS_MDO_PATH }}"
          Log "Working Dir: ${{ vars.HEEDS_WORKING_DIR }}"
          Log "========================================================"

      - name: Set project parameters
        id: params
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $project = "${{ github.event.inputs.heeds_project }}"

          $designs = switch ($project) {
            "quick_test" { 4 }
            "full_sweep" { 576 }
            "Square_Beam_scenario_short_rev" { 576 }
            default { 576 }
          }

          $timeoutMin = [int]"${{ github.event.inputs.timeout_minutes }}"
          $timeoutSec = $timeoutMin * 60

          Log "========================================================"
          Log "  PROJECT PARAMETERS"
          Log "========================================================"
          Log "Selected project: $project"
          Log "Expected designs: $designs"
          Log "Timeout: $timeoutSec seconds ($timeoutMin minutes)"
          Log "========================================================"

          echo "expected_designs=$designs" >> $env:GITHUB_OUTPUT
          echo "timeout_seconds=$timeoutSec" >> $env:GITHUB_OUTPUT

      - name: Kill existing HEEDS processes
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          Log "========================================================"
          Log "  KILLING EXISTING HEEDS PROCESSES"
          Log "========================================================"

          $processes = @("heeds", "HEEDSMDO", "nastran", "nastranw")
          foreach ($proc in $processes) {
            $running = Get-Process -Name $proc -ErrorAction SilentlyContinue
            if ($running) {
              Log "Stopping: $proc (PID: $($running.Id))"
              Stop-Process -Name $proc -Force -ErrorAction SilentlyContinue
            }
          }

          Start-Sleep -Seconds 3

          $stillRunning = Get-Process | Where-Object { $_.Name -match "heeds|HEEDSMDO|nastran" }
          if ($stillRunning) {
            Log "WARNING: Some processes still running:"
            $stillRunning | Format-Table Name, Id
          } else {
            Log "SUCCESS: All HEEDS processes stopped"
          }
          Log "========================================================"

      - name: Handle existing study folder
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $project = "${{ github.event.inputs.heeds_project }}"
          $mode = "${{ github.event.inputs.folder_mode }}"
          $studyFolder = "${{ vars.HEEDS_WORKING_DIR }}\${project}_Study_1"

          Log "========================================================"
          Log "  FOLDER MANAGEMENT"
          Log "========================================================"
          Log "Study folder: $studyFolder"
          Log "Selected mode: $mode"

          if (Test-Path $studyFolder) {
            $folderInfo = Get-Item $studyFolder
            
            Log "[EXISTS] Folder already exists!"
            Log "  Created: $($folderInfo.CreationTime)"
            Log "  Modified: $($folderInfo.LastWriteTime)"

            if ($mode -eq "overwrite_existing") {
              Log "[ACTION] OVERWRITE mode - deleting existing folder..."
              Remove-Item -Path $studyFolder -Recurse -Force
              if (Test-Path $studyFolder) {
                Log "[ERROR] Failed to delete folder!"
                exit 1
              }
              Log "[DONE] Folder deleted successfully"
            }
            elseif ($mode -eq "skip_if_exists") {
              Log "[SKIP] Folder exists - exiting"
              exit 0
            }
          } else {
            Log "[OK] Folder does not exist - will be created by HEEDS"
          }
          Log "========================================================"

      - name: Verify HEEDS project file exists
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $project = "${{ github.event.inputs.heeds_project }}"
          $heedsFile = "${{ github.workspace }}\heeds_projects\${project}.heeds"

          Log "========================================================"
          Log "  VERIFYING HEEDS FILE"
          Log "========================================================"
          Log "Looking for: $heedsFile"

          if (Test-Path $heedsFile) {
            $size = (Get-Item $heedsFile).Length
            Log "SUCCESS: File found (Size: $size bytes)"
            
            # Check for PCH VisFile entry
            $hasPch = Select-String -Path $heedsFile -Pattern "VisFile.*randombeamx\.pch" -Quiet
            if ($hasPch) {
              Log "[OK] PCH VisFile entry found"
            } else {
              Log "[ERROR] PCH VisFile entry MISSING! PCH files will not be saved to POST_0"
              Log "[ERROR] Add this line to the .heeds file:"
              Log '        <VisFile type="data" filename="randombeamx.pch" source="analysisFolder"/>'
              exit 1
            }
          } else {
            Log "ERROR: HEEDS file not found!"
            Log "Available files in heeds_projects:"
            Get-ChildItem "${{ github.workspace }}\heeds_projects\*.heeds" -ErrorAction SilentlyContinue | ForEach-Object {
              Log "  - $($_.Name)"
            }
            exit 1
          }
          Log "========================================================"

      - name: Copy HEEDS file to Documents
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $project = "${{ github.event.inputs.heeds_project }}"
          $source = "${{ github.workspace }}\heeds_projects\${project}.heeds"
          $dest = "${{ vars.HEEDS_WORKING_DIR }}\${project}.heeds"

          Log "========================================================"
          Log "  COPYING HEEDS FILE"
          Log "========================================================"
          Log "From: $source"
          Log "To: $dest"

          Copy-Item -Path $source -Destination $dest -Force

          if (Test-Path $dest) {
            Log "SUCCESS: File copied"
          } else {
            Log "ERROR: Copy failed!"
            exit 1
          }
          Log "========================================================"

      - name: Copy required files to working directory
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $workDir = "${{ vars.HEEDS_WORKING_DIR }}"

          Log "========================================================"
          Log "  COPYING REQUIRED FILES"
          Log "========================================================"

          # Bush.blk - CRITICAL: Use Misc/Bush.blk (Femap format)
          if (Test-Path "${{ github.workspace }}\Misc\Bush.blk") {
            Copy-Item "${{ github.workspace }}\Misc\Bush.blk" "$workDir\Bush.blk" -Force
            Log "[OK] Bush.blk (Femap format - CRITICAL)"
          } else {
            Log "[ERROR] Misc\Bush.blk not found!"
            exit 1
          }

          # FBM_TO_DBALL.bat - CRITICAL for Nastran execution
          if (Test-Path "${{ github.workspace }}\FBM_TO_DBALL.bat") {
            Copy-Item "${{ github.workspace }}\FBM_TO_DBALL.bat" "$workDir\FBM_TO_DBALL.bat" -Force
            Log "[OK] FBM_TO_DBALL.bat"
            
            # Verify it has the /nobreak fix
            $batContent = Get-Content "$workDir\FBM_TO_DBALL.bat" -Raw
            if ($batContent -match "timeout /t 10 /nobreak") {
              Log "[OK] FBM_TO_DBALL.bat has /nobreak fix"
            } else {
              Log "[WARN] FBM_TO_DBALL.bat may be missing /nobreak fix!"
              Log "[WARN] This can cause Nastran to hang waiting for keypress"
            }
          } else {
            Log "[ERROR] FBM_TO_DBALL.bat not found in repo root!"
            exit 1
          }

          # Nastran model files
          if (Test-Path "${{ github.workspace }}\templates\Fixed_base_beam.dat") {
            Copy-Item "${{ github.workspace }}\templates\Fixed_base_beam.dat" "$workDir\" -Force
            Log "[OK] Fixed_base_beam.dat"
          }

          if (Test-Path "${{ github.workspace }}\templates\Recoveries.blk") {
            Copy-Item "${{ github.workspace }}\templates\Recoveries.blk" "$workDir\" -Force
            Log "[OK] Recoveries.blk"
          }

          if (Test-Path "${{ github.workspace }}\templates\RandomBeamX.dat") {
            Copy-Item "${{ github.workspace }}\templates\RandomBeamX.dat" "$workDir\" -Force
            Log "[OK] RandomBeamX.dat"
          }

          # Post-processor script
          if (Test-Path "${{ github.workspace }}\Scripts\Pch_TO_CSV2.py") {
            Copy-Item "${{ github.workspace }}\Scripts\Pch_TO_CSV2.py" "$workDir\" -Force
            Log "[OK] Pch_TO_CSV2.py"
          }

          # Baseline files for delta calculations
          if (Test-Path "${{ github.workspace }}\baseline\acceleration_results.csv") {
            Copy-Item "${{ github.workspace }}\baseline\acceleration_results.csv" "$workDir\acceleration_results_baseline.csv" -Force
            Log "[OK] acceleration_results_baseline.csv"
          }

          if (Test-Path "${{ github.workspace }}\baseline\displacement_results.csv") {
            Copy-Item "${{ github.workspace }}\baseline\displacement_results.csv" "$workDir\displacement_results_baseline.csv" -Force
            Log "[OK] displacement_results_baseline.csv"
          }

          Log "========================================================"

      - name: Verify Bush.blk format
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $workDir = "${{ vars.HEEDS_WORKING_DIR }}"
          $bushFile = "$workDir\Bush.blk"

          Log "========================================================"
          Log "  VERIFYING BUSH.BLK FORMAT"
          Log "========================================================"

          if (Test-Path $bushFile) {
            $content = Get-Content $bushFile -Raw
            if ($content -match '\$ Femap Property') {
              Log "[PASS] Bush.blk has Femap comment lines"
            } else {
              Log "[ERROR] Bush.blk missing Femap comments - charCol mismatch!"
              Log "[ERROR] Use Misc/Bush.blk instead of baseline/Bush.blk"
              exit 1
            }
          } else {
            Log "[ERROR] Bush.blk not found in working directory"
            exit 1
          }
          Log "========================================================"

      - name: Run HEEDS Study
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $project = "${{ github.event.inputs.heeds_project }}"
          $heedsFile = "${{ vars.HEEDS_WORKING_DIR }}\${project}.heeds"
          $runScript = "${{ github.workspace }}\run_study_v2.py"
          $expectedDesigns = ${{ steps.params.outputs.expected_designs }}
          $timeoutSec = ${{ steps.params.outputs.timeout_seconds }}

          Log "========================================================"
          Log "  STARTING HEEDS STUDY"
          Log "========================================================"
          Log "Project: $heedsFile"
          Log "Script: $runScript"
          Log "Expected designs: $expectedDesigns"
          Log "Timeout: $timeoutSec seconds"
          Log "========================================================"

          if (-not (Test-Path $runScript)) {
            Log "ERROR: run_study_v2.py not found at $runScript"
            exit 1
          }

          $heedsExe = "${{ vars.HEEDS_MDO_PATH }}"
          Log "Starting HEEDS..."
          Log "Executable: $heedsExe"
          Log "Command: $heedsExe -b -script `"$runScript`" -project `"$heedsFile`""

          $process = Start-Process -FilePath $heedsExe `
            -ArgumentList "-b", "-script", "`"$runScript`"", "-project", "`"$heedsFile`"" `
            -PassThru -NoNewWindow -WorkingDirectory "${{ vars.HEEDS_WORKING_DIR }}"

          Log "HEEDS started (PID: $($process.Id))"

          $studyFolder = "${{ vars.HEEDS_WORKING_DIR }}\${project}_Study_1"
          $post0Folder = "$studyFolder\POST_0"
          $startTime = Get-Date
          $folderTimeout = 300

          Log ""
          Log "Waiting for study folder..."

          while (-not (Test-Path $studyFolder)) {
            $elapsed = ((Get-Date) - $startTime).TotalSeconds
            if ($elapsed -gt $folderTimeout) {
              Log "ERROR: Study folder not created after $folderTimeout seconds"
              Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
              exit 1
            }
            Log "  Waiting... ($([int]$elapsed)s / ${folderTimeout}s)"
            Start-Sleep -Seconds 10
          }

          Log "SUCCESS: Study folder created!"

          # Monitor progress using POST_0 with file verification (Option B)
          Log ""
          Log "========================================================"
          Log "  MONITORING PROGRESS (POST_0 + PCH/CSV Verification)"
          Log "========================================================"

          $lastCount = 0
          $stallTime = 0
          $maxStall = 600

          while ($true) {
            $elapsed = ((Get-Date) - $startTime).TotalSeconds

            # Option B: Count designs where BOTH PCH and CSV exist in POST_0
            $completed = 0
            $designFolders = Get-ChildItem "$post0Folder\Design*" -Directory -ErrorAction SilentlyContinue
            foreach ($design in $designFolders) {
              $pchExists = Test-Path "$($design.FullName)\Analysis_1\randombeamx.pch"
              $csvExists = Test-Path "$($design.FullName)\Analysis_1\acceleration_results.csv"
              if ($pchExists -and $csvExists) { $completed++ }
            }
            
            $totalFolders = ($designFolders | Measure-Object).Count

            $pct = if ($expectedDesigns -gt 0) { [math]::Round(($completed / $expectedDesigns) * 100, 1) } else { 0 }
            $barLen = 40
            $filled = [math]::Min($barLen, [math]::Floor($barLen * $completed / $expectedDesigns))
            $bar = ("#" * $filled) + ("-" * ($barLen - $filled))

            Log "[$bar] $completed/$expectedDesigns verified ($pct%) | POST_0: $totalFolders | Elapsed: $([int]$elapsed)s"

            if ($completed -ge $expectedDesigns) {
              Log ""
              Log "========================================================"
              Log "  STUDY COMPLETE!"
              Log "========================================================"
              Log "Verified completed designs: $completed"
              Log "Total time: $([int]$elapsed) seconds ($([math]::Round($elapsed/60, 1)) minutes)"
              break
            }

            if ($elapsed -gt $timeoutSec) {
              Log ""
              Log "ERROR: Study timed out after $timeoutSec seconds"
              Log "Verified completed: $completed / $expectedDesigns"
              Stop-Process -Name "heeds" -Force -ErrorAction SilentlyContinue
              Stop-Process -Name "HEEDSMDO" -Force -ErrorAction SilentlyContinue
              Stop-Process -Name "nastran" -Force -ErrorAction SilentlyContinue
              exit 1
            }

            if ($completed -eq $lastCount) {
              $stallTime += 15
              if ($stallTime -ge $maxStall) {
                Log ""
                Log "ERROR: Study stalled - no progress for $maxStall seconds"
                Log "Verified completed: $completed / $expectedDesigns"
                Stop-Process -Name "heeds" -Force -ErrorAction SilentlyContinue
                Stop-Process -Name "HEEDSMDO" -Force -ErrorAction SilentlyContinue
                Stop-Process -Name "nastran" -Force -ErrorAction SilentlyContinue
                exit 1
              }
            } else {
              $stallTime = 0
              $lastCount = $completed
            }

            Start-Sleep -Seconds 15
          }

      - name: Validate Results
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $project = "${{ github.event.inputs.heeds_project }}"
          $studyFolder = "${{ vars.HEEDS_WORKING_DIR }}\${project}_Study_1"
          $post0Folder = "$studyFolder\POST_0"
          $expectedDesigns = ${{ steps.params.outputs.expected_designs }}

          Log "========================================================"
          Log "  VALIDATING RESULTS"
          Log "========================================================"

          $pchCount = (Get-ChildItem "$post0Folder\Design*\Analysis_1\*.pch" -ErrorAction SilentlyContinue | Measure-Object).Count
          $csvCount = (Get-ChildItem "$post0Folder\Design*\Analysis_1\*_results.csv" -ErrorAction SilentlyContinue | Measure-Object).Count
          $folderCount = (Get-ChildItem "$post0Folder\Design*" -Directory -ErrorAction SilentlyContinue | Measure-Object).Count

          Log "POST_0 Design folders: $folderCount"
          Log "PCH files: $pchCount"
          Log "CSV result files: $csvCount"
          Log "Expected designs: $expectedDesigns"

          if ($pchCount -eq 0) {
            Log ""
            Log "[ERROR] NO PCH FILES FOUND!"
            Log "[ERROR] Nastran analysis did not complete successfully"
            Log ""
            Log "=== DIAGNOSTIC INFO ==="
            Log ""
            Log "--- Analysis.log (Design1) ---"
            $logPath = "$post0Folder\Design1\Analysis_1\Analysis.log"
            if (Test-Path $logPath) {
              Get-Content $logPath
            } else {
              Log "Analysis.log not found"
            }
            Log ""
            Log "--- Tool Output (Design1) ---"
            $msgPath = "$post0Folder\Design1\Analysis_1\Tool_Analysis_1_output.msg"
            if (Test-Path $msgPath) {
              Get-Content $msgPath
            } else {
              Log "Tool output not found"
            }
            Log ""
            Log "--- FBM_TO_DBALL.bat check ---"
            $batPath = "${{ vars.HEEDS_WORKING_DIR }}\FBM_TO_DBALL.bat"
            if (Test-Path $batPath) {
              Log "FBM_TO_DBALL.bat exists"
              Log "Content:"
              Get-Content $batPath
            } else {
              Log "[ERROR] FBM_TO_DBALL.bat NOT FOUND in working directory!"
            }
            Log ""
            Log "--- HEEDS_0 Design folder contents ---"
            $heeds0Path = "$studyFolder\HEEDS_0\Design_0001"
            if (Test-Path $heeds0Path) {
              Get-ChildItem $heeds0Path | Select-Object Name, Length
            } else {
              Log "HEEDS_0\Design_0001 not found"
            }
            Log ""
            Log "========================================================"
            exit 1
          }

          if ($csvCount -eq 0) {
            Log ""
            Log "[ERROR] NO CSV FILES FOUND!"
            Log "[ERROR] Post-processing (Pch_TO_CSV2.py) may have failed"
            exit 1
          }

          if ($pchCount -lt $expectedDesigns) {
            Log ""
            Log "[WARN] Not all designs completed"
            Log "[WARN] Expected: $expectedDesigns, Got: $pchCount"
          }

          Log ""
          Log "[SUCCESS] Results validated!"
          Log "========================================================"

      - name: Cleanup HEEDS processes
        if: always()
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          Log "========================================================"
          Log "  FINAL CLEANUP"
          Log "========================================================"

          Stop-Process -Name "heeds" -Force -ErrorAction SilentlyContinue
          Stop-Process -Name "HEEDSMDO" -Force -ErrorAction SilentlyContinue
          Stop-Process -Name "nastran" -Force -ErrorAction SilentlyContinue
          Stop-Process -Name "nastranw" -Force -ErrorAction SilentlyContinue

          Start-Sleep -Seconds 2

          $remaining = Get-Process | Where-Object { $_.Name -match "heeds|HEEDSMDO|nastran" }
          if ($remaining) {
            Log "WARNING: Some processes still running"
          } else {
            Log "SUCCESS: All HEEDS processes stopped"
          }
          Log "========================================================"

      - name: Report Results
        if: always()
        shell: powershell
        run: |
          function Log { param([string]$Message) Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $Message" }
          
          $project = "${{ github.event.inputs.heeds_project }}"
          $studyFolder = "${{ vars.HEEDS_WORKING_DIR }}\${project}_Study_1"

          Log "========================================================"
          Log "  FINAL REPORT"
          Log "========================================================"

          if (Test-Path $studyFolder) {
            $post0Folder = "$studyFolder\POST_0"
            $heeds0Folder = "$studyFolder\HEEDS_0"
            
            $post0Designs = (Get-ChildItem "$post0Folder\Design*" -Directory -ErrorAction SilentlyContinue | Measure-Object).Count
            $pchFiles = (Get-ChildItem "$post0Folder\Design*\Analysis_1\*.pch" -ErrorAction SilentlyContinue | Measure-Object).Count
            $csvFiles = (Get-ChildItem "$post0Folder\Design*\Analysis_1\*_results.csv" -ErrorAction SilentlyContinue | Measure-Object).Count
            $heeds0Designs = (Get-ChildItem "$heeds0Folder\Design*" -Directory -ErrorAction SilentlyContinue | Measure-Object).Count

            Log "Study folder: $studyFolder"
            Log ""
            Log "POST_0 (completed results):"
            Log "  Design folders: $post0Designs"
            Log "  PCH files: $pchFiles"
            Log "  CSV result files: $csvFiles"
            Log ""
            Log "HEEDS_0 (working folder):"
            Log "  Design folders: $heeds0Designs"

            $resFile = "$heeds0Folder\HEEDS0.res"
            if (Test-Path $resFile) {
              $size = [math]::Round((Get-Item $resFile).Length / 1MB, 2)
              Log "HEEDS results file: $size MB"
            }

            $logFile = "$studyFolder\Study_1.log"
            if (Test-Path $logFile) {
              Log ""
              Log "=== Study Log (last 20 lines) ==="
              Get-Content $logFile -Tail 20
            }
          } else {
            Log "WARNING: Study folder not found"
          }
          Log "========================================================"
